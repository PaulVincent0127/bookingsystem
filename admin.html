<?php
include('customerChecker.php');
$title = "Book Session";
include('pageIncludes.php');
$book = "active show";
include('customerHeader.php');
date_default_timezone_set('Asia/Manila');
?>
<link href="../css/metalcore.css" rel="stylesheet">


<div class="az-content az-content-dashboard">
  <div class="container">
    <div class="az-content-body">
      <?php
        if(isset($_GET['welcome'])){
      ?>
      <div class="alert alert-success" role="alert">
        <h4 class="alert-heading">Welcome <?= $_SESSION['name']?>!</h4>
        <hr>
        <p>We are pleased to serve you. Please continue by creating session schedule.</p>
      </div>
    <?php }?>
      <div class="az-dashboard-one-title">
        <div>
          <h2 class="az-dashboard-title">Book Now</h2>
          <p class="az-dashboard-text">Please all desired inputs.</p>
        </div>
        <div class="az-content-header-right">
          <div class="media">
            <div class="media-body ">
              <label>Today's Date</label>
              <h6><?= date('l,  M d, Y ', time()); ?></h6>
            </div><!-- media-body -->
          </div><!-- media -->
        </div>
      </div>
      <div class="row row-sm mg-b-20 d-block d-lg-none d-sm-none d-md-block d-sm-block">
        <div class="col-lg-7 ht-lg-100p">
          <div class="az-dashboard-nav d-md-block d-sm-block">
            <nav class="nav d-md-block d-sm-block">
              <span class="nav-link d-md-block d-sm-block" >Today's Date: <b><?= date('l,  M d, Y ', time()); ?></b></span>

            </nav>
          </div>
        </div><!-- col -->
      </div><!-- row -->
      <div class="row row-lg mg-b-20">
        <div class="col-lg-12 ht-lg-100p">
          <div class="card card-dashboard-two">
            <div class="card-header">

              <form method="post" action="insertBooking.php" id="scheduleForm">

                  <div class="row">
                    <div class="col-lg-5">
                  <div class="row">
                    <div class="col-lg-12">
                      Desired Session Date
                      <div class="input-group" >
                        <div class="input-group-prepend">
                          <div class="input-group-text">
                            <i class="typcn typcn-calendar-outline tx-24 lh--9 op-6"></i>
                          </div>
                        </div>
                        <input id="datepickerNoOfMonths" type="date" class="form-control" name="date"  style="background-color:white" value="" readonly="readonly" required>
                      </div>
                    </div>
                    </div>
                    <hr>
                      Select Session
                      <div class="row" >
                      <?php
                        //get all sessions
                        $sql = "SELECT * FROM sessions";
                        $query = mysqli_query($db,$sql);
                        $x = 1;
                        while( $s = mysqli_fetch_array($query) ){

                      ?>
                        <div class="col-lg-4 sess-cards sess-<?= $x?>" style="color:grey" >
                          <label class="label-" style="width:100%; padding-top:5px;">
                            <input type="radio" name="session" value="<?= $s['session_id']?>" class="card-input-element d-none session radio-<?= $x?>" data-name="<?= $s['session_type']?>" data-price="<?= $s['session_price']?>" id="demo1" required disabled>
                            <span class="card card-body bg-light " style="padding:5px; ">
                              <center><b style="font-size:16px"><?= $s['session_type']?></b></center>
                              <hr style="margin-top:3px; margin-bottom:3px">
                              <?= $s['session_description']?>
                              <hr style="margin-top:3px; margin-bottom:3px">
                              <?= $s['session_time']?> Daily
                              <hr style="margin-top:3px; margin-bottom:3px">
                              Php <?= $s['session_price']?>
                            </br>
                            </span>
                            </label>
                        </div>
                      <?php $x++;
                          }?>
                      </div>
                    </div>
                    <div class="col-lg-4">

                      Trainer
                      <select class="form-control" id="trainers" name="trainer" disabled required>
                        <option value="">Select session first.</option>
                      </select>
                      <br>
                      <div class="alert alert-outline-danger d-none" id="error-msg">
                        It's either you already have this schedule or the slots are full. Change the <b>date</b> or pick another <b>session</b>.
                      </div>
                      <div class="alert alert-outline-danger d-none" id="error-msg2">
                        No available session for <b>Current time</b>. Please choose another date.
                      </div>
                    </div><!-- wd-200 -->
                    <div class="col-lg-3">
                      <h4>Summary</h4>

                      <hr>
                      Session<br>
                      <b><span id="session-sum">No session selected.</span></b>
                      <br>
                      Trainer<br>
                      <b><span id="trainer-sum">No trainer selected.</span></b>
                      <br>
                      Schedule Date<br>
                      <b><span id="date-sum">No date selected.</span></b>
                      <br>
                      Slots Left<br>
                      <b><span id="slots-sum">0</span></b><br>
                      Price<br>
                      <b><span id="price-sum">0</span></b>
                      <hr>
                      <button name="submit" class="btn btn-purple" id="submit"  style="width:100%" disabled>Book</submit>
                        <button disabled class="btn btn-purple" type=button id="submit2" style="display: none; width:100%">Submitting...</button>
                    </div><!-- wd-200 -->
                  </div>





                <br>
              </form>
            </div><!-- card-header -->
          </div><!-- card -->
        </div><!-- col -->
      </div><!-- row -->

    </div>
   </div>
 </div>
 <script src="../AziaTemplate/js/azia.js"></script>

 <?php
 include('customerFooter.php');
 ?>
    <script src="../AziaTemplate/lib/jquery/jquery.min.js"></script>
    <script src="../AziaTemplate/lib/jquery-ui/ui/widgets/datepicker.js"></script>
    <script src="../AziaTemplate/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../AziaTemplate/lib/ionicons/ionicons.js"></script>
    <script src="../AziaTemplate/lib/jquery.maskedinput/jquery.maskedinput.js"></script>
    <script src="../AziaTemplate/lib/spectrum-colorpicker/spectrum.js"></script>
    <script src="../AziaTemplate/lib/select2/js/select2.min.js"></script>
    <script src="../AziaTemplate/lib/ion-rangeslider/js/ion.rangeSlider.min.js"></script>
    <script src="../AziaTemplate/lib/amazeui-datetimepicker/js/amazeui.datetimepicker.min.js"></script>
    <script src="../AziaTemplate/lib/jquery-simple-datetimepicker/jquery.simple-dtpicker.js"></script>
    <script src="../AziaTemplate/lib/pickerjs/picker.min.js"></script>


    <script>
      $(function(){
        'use strict'
        var session = "";

        $('#datepickerNoOfMonths').datepicker({
          dateFormat: 'yy-mm-dd',
          minDate: '0',
          showOtherMonths: true,
          selectOtherMonths: true,
          numberOfMonths: 2,
          beforeShowDay: function(date) {
              var day = date.getDay();
              return [(day != 0), ''];
          }
        });

      });


      //activate select trainer form
      $('#datepickerNoOfMonths').on('change', function(){
        var date = $(this).val();
        $('#date-sum').text(date);
        var d = new Date(),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours = d.getHours(),
        minutes = d.getMinutes()
        ;
        $('#trainers').empty().append('<option selected="selected" value="">Select session first.</option>').prop("disabled", true);
        $('#error-msg').addClass('d-none');
        if (month.length < 2)
            month = '0' + month;

        if (minutes.length < 2)
            minutes = '0' + minutes;

        if (day.length < 2)
            day = '0' + day;

        current_date =  [year, month, day].join('-');

        if(date != ''){

          if(date == current_date){
            var time_now = hours+':'+minutes;
            var stt = new Date("November 13, 2022 " + time_now);
            stt = stt.getTime();

            var timeWeights = new Date("November 13, 2022 8:00" );
            timeWeights = timeWeights.getTime();
            var timeKicks = new Date("November 13, 2022 9:00" );
            timeKicks = timeKicks.getTime();
            var timePT = new Date("November 13, 2022 12:00" );
            timePT = timePT.getTime();

            if(stt < timeWeights){
              $(".session ").prop('disabled', false);
              $(".sess-cards").removeAttr("style");
            }

            if(stt > timeWeights){
              $(".session ").prop('disabled', false);
              $(".sess-cards").removeAttr("style");
              $(".radio-1").prop('disabled', true);
              $(".sess-1").css("color", "grey")
            }
            if(stt > timeKicks){
              $(".sess-2").css("color", "grey");
              $(".radio-2").prop('disabled', true);
              $(".radio-3").prop('disabled', false);
              $(".sess-3").removeAttr("style");
            }

            if(stt > timePT){
              $(".sess-3").css("color", "grey");
              $(".radio-3").prop('disabled', true);
              $('#error-msg').addClass('d-none');
              $('#error-msg2').removeClass('d-none');
              $( "#trainers, #submit" ).prop( "disabled", true );
              $('#trainers').empty().append('<option selected="selected" value="">No Available trainer.</option>');
              $('#slots-sum').text('0');
              $('#trainer-sum').text('No trainer selected.');
            }
          } else {
            $(".session").prop('disabled', false);
            $(".sess-cards").removeAttr("style");
            $('#error-msg2').addClass('d-none');
          }
          $(".session").prop('checked', false);
          getTrainer();
        } else {
          $( "#trainers" ).prop( "disabled", true );
        }

      });

      $('.session').on('change', function(){
        var price = $(this).attr('data-price');
        var session = $(this).attr('data-name');
        $('#price-sum').text('Php '+price);
        $('#session-sum').text(session);
        $('#datepickerNoOfMonths, #submit').prop( "disabled", false );
        $('#datepickerNoOfMonths').attr("placeholder", "YYYY-MM-DD");
        getTrainer();
      });

      $('#trainers').on('change', function(){
        var trainer = $('select#trainers').find(':selected').data('name');
        var slots = $('select#trainers').find(':selected').data('slots');
        $('#trainer-sum').text(trainer);
        $('#slots-sum').text(slots);
      });

      function getTrainer(){
        //get available trainer for this date
        var date = $('#datepickerNoOfMonths').val();
        var session = $('input[name=session]:checked').val();

        if( date != '' && session != ''){
          $.ajax({
              type: "POST",
              url: "jQueryChecker.php",
              dataType: "json",
              data: {
                      "date": date,
                      "session": session,
                      "trainer" : "true"
                    },
                    success: function (response) {
                      var len = Object.keys(response).length;
                      if(len>0){
                        $( "#trainers" ).prop( "disabled", false );
                        $('#error-msg').addClass('d-none');
                        $('#trainers').empty().append('<option selected="selected" value="">Select Trainer</option>');
                        for(var i=0; i<len; i++){
                          var trainer_id = response[i].trainer_id;
                          var name = response[i].name;
                          var slots = response[i].slots;
                          $('#trainers').append('<option value="'+trainer_id+'" data-name="'+name+'" data-slots="'+slots+'">'+name+' - '+slots+' slots left</option>');
                        }
                      } else {
                        $('#error-msg').removeClass('d-none');
                        $( "#trainers, #submit" ).prop( "disabled", true );
                        $('#trainers').empty().append('<option selected="selected" value="">No Available trainer.</option>');
                        $('#slots-sum').text('0');
                        $('#trainer-sum').text('No trainer selected.');
                      }
                  }
            });
          }
        }
        //check inputs are valid before submitting

          $('#scheduleForm').on('submit', function(e){
              var trainer = $('#trainers').val();
              if (trainer != '') {
                 $("#submit").hide();
                 $("#submit2").show();
                this.submit();

              } else {
                  $( "#submit" ).prop( "disabled", true );
              }
              e.preventDefault();
            });

    </script>
  </body>
</html>
